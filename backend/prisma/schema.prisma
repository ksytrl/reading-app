// backend/prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  email     String?  @unique
  password  String
  avatar    String?
  bio       String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isVip     Boolean  @default(false)
  vipExpiresAt DateTime?
  
  // ğŸ“Š ç”¨æˆ·ç»Ÿè®¡
  followerCount Int @default(0)
  followingCount Int @default(0)
  readingTime Int @default(0) // æ€»é˜…è¯»æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
  booksRead Int @default(0)  // å·²è¯»ä¹¦ç±æ•°é‡
  
  // ğŸ¯ ç”¨æˆ·åå¥½ï¼ˆç”¨äºæ¨èç³»ç»Ÿï¼‰
  preferredCategories String? // JSONæ•°ç»„å­˜å‚¨å–œæ¬¢çš„åˆ†ç±»
  readingHabits Json? // é˜…è¯»ä¹ æƒ¯æ•°æ®
  lastActiveAt DateTime @default(now())

  // å…³è”
  bookshelf UserBookshelf[]
  readingRecords ReadingRecord[]
  reviews BookReview[]
  readingSettings UserReadingSettings?
  
  // ğŸ¯ ç¤¾äº¤åŠŸèƒ½å…³è”
  followers UserFollows[] @relation("UserFollowers")
  following UserFollows[] @relation("UserFollowing")
  shares Share[]
  discussions Discussion[]
  discussionComments DiscussionComment[]
  reactions Reaction[]
  
  // ğŸ“š æ¨èç³»ç»Ÿå…³è”
  recommendations Recommendation[]
  readingGoals ReadingGoal[]

  @@map("users")
}

// ğŸ¯ æ–°å¢ï¼šç”¨æˆ·å…³æ³¨ç³»ç»Ÿ
model UserFollows {
  id Int @id @default(autoincrement())
  followerId Int
  followingId Int
  createdAt DateTime @default(now())
  
  // å…³è”
  follower User @relation("UserFollowing", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("UserFollowers", fields: [followingId], references: [id], onDelete: Cascade)
  
  @@unique([followerId, followingId])
  @@map("user_follows")
}

model Category {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  description String?
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)
  icon        String? // åˆ†ç±»å›¾æ ‡
  
  // ğŸ“Š åˆ†ç±»ç»Ÿè®¡
  bookCount   Int     @default(0)
  popularityScore Float @default(0) // çƒ­é—¨åº¦è¯„åˆ†

  // å…³è”
  books Book[]

  @@map("categories")
}

model Book {
  id              Int      @id @default(autoincrement())
  title           String
  author          String
  categoryId      Int?
  cover           String?
  description     String   @db.Text
  totalWords      Int      @default(0)
  totalChapters   Int      @default(0)
  status          BookStatus @default(ONGOING)
  isFree          Boolean  @default(true)
  price           Float    @default(0.00)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  lastChapterUpdate DateTime?
  viewCount       Int      @default(0)
  favoriteCount   Int      @default(0)
  rating          Float    @default(0.00)
  isFeatured      Boolean  @default(false)
  tags            Json?
  
  // ğŸ“Š æ¨èç³»ç»Ÿå­—æ®µ
  popularityScore Float @default(0) // çƒ­é—¨åº¦è¯„åˆ†
  qualityScore Float @default(0)    // è´¨é‡è¯„åˆ†
  trendingScore Float @default(0)   // è¶‹åŠ¿è¯„åˆ†
  
  // ğŸ“± å¤šæ ¼å¼æ”¯æŒ
  formats Json? // æ”¯æŒçš„æ ¼å¼ä¿¡æ¯ {"epub": "url", "pdf": "url", "txt": "url"}
  originalFormat String @default("txt") // åŸå§‹æ ¼å¼
  fileSize Int @default(0) // æ–‡ä»¶å¤§å°(å­—èŠ‚)

  // å…³è”
  category Category? @relation(fields: [categoryId], references: [id])
  chapters Chapter[]
  bookshelf UserBookshelf[]
  readingRecords ReadingRecord[]
  reviews BookReview[]
  
  // ğŸ¯ ç¤¾äº¤åŠŸèƒ½å…³è”
  shares Share[]
  discussions Discussion[]
  reactions Reaction[]
  
  // ğŸ“š æ¨èç³»ç»Ÿå…³è”
  recommendations Recommendation[]

  @@map("books")
}

model Chapter {
  id            Int      @id @default(autoincrement())
  bookId        Int
  chapterNumber Int
  title         String
  content       String   @db.LongText
  wordCount     Int      @default(0)
  isFree        Boolean  @default(true)
  price         Float    @default(0.00)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // ğŸ“± å¤šæ ¼å¼æ”¯æŒ
  htmlContent   String?  @db.LongText // HTMLæ ¼å¼å†…å®¹
  markdownContent String? @db.LongText // Markdownæ ¼å¼å†…å®¹

  // å…³è”
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)
  readingRecords ReadingRecord[]

  @@unique([bookId, chapterNumber])
  @@map("chapters")
}

model UserBookshelf {
  id         Int      @id @default(autoincrement())
  userId     Int
  bookId     Int
  addedAt    DateTime @default(now())
  lastReadAt DateTime?
  isFavorite Boolean  @default(false)
  
  // ğŸ“Š é˜…è¯»ç»Ÿè®¡
  readingProgress Float @default(0) // é˜…è¯»è¿›åº¦ç™¾åˆ†æ¯”
  totalReadingTime Int @default(0) // é˜…è¯»æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰

  // å…³è”
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@unique([userId, bookId])
  @@map("user_bookshelf")
}

model ReadingRecord {
  id                 Int      @id @default(autoincrement())
  userId             Int
  bookId             Int
  chapterId          Int
  progressPercentage Float    @default(0.00)
  readingPosition    Int      @default(0)
  readingTime        Int      @default(0)
  lastReadAt         DateTime @default(now()) @updatedAt
  
  // ğŸ“Š é˜…è¯»è¡Œä¸ºæ•°æ®ï¼ˆç”¨äºæ¨èç³»ç»Ÿï¼‰
  sessionDuration Int @default(0) // æœ¬æ¬¡é˜…è¯»æ—¶é•¿ï¼ˆç§’ï¼‰
  scrollSpeed Float @default(0)   // é˜…è¯»é€Ÿåº¦
  deviceType String @default("web") // è®¾å¤‡ç±»å‹

  // å…³è”
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  book    Book    @relation(fields: [bookId], references: [id], onDelete: Cascade)
  chapter Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@unique([userId, bookId, chapterId])
  @@map("reading_records")
}

model UserReadingSettings {
  id             Int      @id @default(autoincrement())
  userId         Int      @unique
  fontSize       FontSize @default(MEDIUM)
  fontFamily     String   @default("é»˜è®¤")
  lineHeight     Float    @default(1.5)
  theme          Theme    @default(DAY)
  backgroundColor String  @default("#FFFFFF")
  textColor      String   @default("#333333")
  pageMargin     Int      @default(20)
  autoScroll     Boolean  @default(false)
  scrollSpeed    Int      @default(3)
  screenAlwaysOn Boolean  @default(false)

  // å…³è”
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_reading_settings")
}

model BookReview {
  id         Int      @id @default(autoincrement())
  userId     Int
  bookId     Int
  rating     Int      @db.TinyInt // 1-5æ˜Ÿè¯„åˆ†
  content    String?  @db.Text
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  likesCount Int      @default(0)
  
  // ğŸ¯ è¯„è®ºè´¨é‡æ ‡è®°
  isVerified Boolean @default(false) // æ˜¯å¦ä¸ºè®¤è¯è¯„è®º
  helpfulCount Int @default(0)       // æœ‰ç”¨è¯„ä»·æ•°

  // å…³è”
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)
  reactions Reaction[]

  @@unique([userId, bookId])
  @@map("book_reviews")
}

// ğŸ¯ æ–°å¢ï¼šåˆ†äº«åŠŸèƒ½
model Share {
  id Int @id @default(autoincrement())
  userId Int
  bookId Int
  platform String // åˆ†äº«å¹³å°ï¼š'wechat', 'weibo', 'qq', 'link'
  content String? @db.Text // åˆ†äº«æ–‡æ¡ˆ
  createdAt DateTime @default(now())
  
  // ğŸ“Š åˆ†äº«ç»Ÿè®¡
  clickCount Int @default(0)
  
  // å…³è”
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)
  
  @@map("shares")
}

// ğŸ¯ æ–°å¢ï¼šè®¨è®ºåŠŸèƒ½
model Discussion {
  id Int @id @default(autoincrement())
  userId Int
  bookId Int?
  title String
  content String @db.Text
  type DiscussionType @default(GENERAL)
  isSticky Boolean @default(false) // æ˜¯å¦ç½®é¡¶
  isLocked Boolean @default(false) // æ˜¯å¦é”å®š
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // ğŸ“Š è®¨è®ºç»Ÿè®¡
  viewCount Int @default(0)
  commentCount Int @default(0)
  likeCount Int @default(0)
  
  // å…³è”
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  book Book? @relation(fields: [bookId], references: [id], onDelete: SetNull)
  comments DiscussionComment[]
  reactions Reaction[]
  
  @@map("discussions")
}

// ğŸ¯ æ–°å¢ï¼šè®¨è®ºè¯„è®º
model DiscussionComment {
  id Int @id @default(autoincrement())
  discussionId Int
  userId Int
  content String @db.Text
  parentId Int? // æ”¯æŒå›å¤è¯„è®º
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // ğŸ“Š è¯„è®ºç»Ÿè®¡
  likeCount Int @default(0)
  
  // å…³è”
  discussion Discussion @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent DiscussionComment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies DiscussionComment[] @relation("CommentReplies")
  reactions Reaction[]
  
  @@map("discussion_comments")
}

// ğŸ¯ æ–°å¢ï¼šé€šç”¨ååº”ç³»ç»Ÿï¼ˆç‚¹èµã€ä¸å–œæ¬¢ç­‰ï¼‰
model Reaction {
  id Int @id @default(autoincrement())
  userId Int
  type ReactionType
  
  // å…³è”ç›®æ ‡ï¼ˆåªèƒ½é€‰æ‹©ä¸€ä¸ªï¼‰
  bookId Int?
  reviewId Int?
  discussionId Int?
  commentId Int?
  
  createdAt DateTime @default(now())
  
  // å…³è”
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  book Book? @relation(fields: [bookId], references: [id], onDelete: Cascade)
  review BookReview? @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  discussion Discussion? @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  comment DiscussionComment? @relation(fields: [commentId], references: [id], onDelete: Cascade)
  
  @@unique([userId, type, bookId, reviewId, discussionId, commentId])
  @@map("reactions")
}

// ğŸ“š æ–°å¢ï¼šæ¨èç³»ç»Ÿ
model Recommendation {
  id Int @id @default(autoincrement())
  userId Int
  bookId Int
  score Float // æ¨èè¯„åˆ† 0-1
  reason String? // æ¨èç†ç”±
  algorithm String // æ¨èç®—æ³•ï¼š'collaborative', 'content', 'hybrid', 'trending'
  createdAt DateTime @default(now())
  
  // ğŸ“Š æ¨èæ•ˆæœè·Ÿè¸ª
  isClicked Boolean @default(false)
  isAdded Boolean @default(false) // æ˜¯å¦åŠ å…¥ä¹¦æ¶
  
  // å…³è”
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)
  
  @@unique([userId, bookId, algorithm])
  @@map("recommendations")
}

// ğŸ“š æ–°å¢ï¼šé˜…è¯»ç›®æ ‡
model ReadingGoal {
  id Int @id @default(autoincrement())
  userId Int
  type ReadingGoalType
  target Int // ç›®æ ‡æ•°é‡
  current Int @default(0) // å½“å‰è¿›åº¦
  period String // æ—¶é—´å‘¨æœŸï¼š'daily', 'weekly', 'monthly', 'yearly'
  startDate DateTime
  endDate DateTime
  isCompleted Boolean @default(false)
  createdAt DateTime @default(now())
  
  // å…³è”
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("reading_goals")
}

// æšä¸¾å®šä¹‰
enum BookStatus {
  ONGOING
  COMPLETED
  PAUSED
}

enum FontSize {
  SMALL
  MEDIUM
  LARGE
}

enum Theme {
  DAY
  NIGHT
  SEPIA
  CLASSIC
}

enum DiscussionType {
  GENERAL     // ä¸€èˆ¬è®¨è®º
  BOOK_REVIEW // ä¹¦è¯„è®¨è®º
  CHAPTER     // ç« èŠ‚è®¨è®º
  AUTHOR      // ä½œè€…è®¨è®º
  QUESTION    // é—®ç­”
}

enum ReactionType {
  LIKE
  DISLIKE
  LOVE
  HAHA
  WOW
  SAD
  ANGRY
}

enum ReadingGoalType {
  BOOKS       // é˜…è¯»ä¹¦ç±æ•°é‡
  CHAPTERS    // é˜…è¯»ç« èŠ‚æ•°é‡
  TIME        // é˜…è¯»æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
  WORDS       // é˜…è¯»å­—æ•°
}