// prisma/seed.ts
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function main() {
  console.log('🌱 开始插入真实书籍内容...');

  // 创建分类
  const categories = await Promise.all([
    prisma.category.upsert({
      where: { name: '玄幻' },
      update: {},
      create: {
        name: '玄幻',
        description: '玄幻奇幻类小说',
        sortOrder: 1
      }
    }),
    prisma.category.upsert({
      where: { name: '科幻' },
      update: {},
      create: {
        name: '科幻',
        description: '科幻未来类小说',
        sortOrder: 2
      }
    }),
    prisma.category.upsert({
      where: { name: '武侠' },
      update: {},
      create: {
        name: '武侠',
        description: '武侠江湖类小说',
        sortOrder: 3
      }
    }),
    prisma.category.upsert({
      where: { name: '经典' },
      update: {},
      create: {
        name: '经典',
        description: '经典文学作品',
        sortOrder: 4
      }
    })
  ]);

  console.log('✅ 分类创建成功');

  // 真实书籍数据
  const realBooks = [
    {
      title: '三国演义',
      author: '罗贯中',
      categoryId: categories.find(c => c.name === '经典')?.id,
      description: '《三国演义》是中国古典四大名著之一，是中国第一部长篇章回体历史演义小说，全名为《三国志通俗演义》。作者一般被认为是元末明初的罗贯中。描写了从东汉末年到西晋初年之间近105年的历史风云，以描写战争为主，反映了东汉末年的群雄割据混战和汉、魏、吴三国之间的政治和军事斗争。',
      totalWords: 800000,
      totalChapters: 120,
      status: 'COMPLETED' as const,
      isFree: true,
      rating: 4.8,
      isFeatured: true,
      tags: ['经典', '历史', '战争', '英雄', '智谋'],
      chapters: [
        {
          chapterNumber: 1,
          title: '桃园三结义',
          content: `第一回 宴桃园豪杰三结义 斩黄巾英雄首立功

话说天下大势，分久必合，合久必分。周末七国分争，并入于秦。及秦灭之后，楚、汉分争，又并入于汉。汉朝自高祖斩白蛇而起义，一统天下，后来光武中兴，传至献帝，遂分为三国。

话说当日，桃花村中，有一豪杰，姓刘名备，字玄德。此人身长七尺五寸，两耳垂肩，双手过膝，目能自顾其耳，面如冠玉，唇若涂脂；中山靖王刘胜之后，汉景帝阁下玄孙，姓刘名备，字玄德。幼丧父，与母贩履织席为业。家住本州涿郡涿县楼桑村人也。

这刘备自小与关羽、张飞二人交厚。关羽字云长，河东解良人也，身长九尺，髯长二尺；面如重枣，唇若涂脂；丹凤眼，卧蚕眉，相貌堂堂，威风凛凛。张飞字翼德，燕人也，身长八尺，豹头环眼，燕颔虎须，声若巨雷，势如奔马。

一日，刘备在涿郡楼桑村中，见一招军榜文，乃是招募义兵，共讨黄巾。备看毕，叹息不已。随后一人厉声曰："大丈夫不与国家出力，何故长叹？"备回视其人，身长九尺，髯长二尺，面如重枣，唇若涂脂，丹凤眼，卧蚕眉，相貌堂堂，威风凛凛。

备见他形貌异常，问其姓名。其人曰："吾姓关名羽，字长生，后改云长，河东解良人也。因本处势豪仗势欺人，被吾杀了，逃难江湖，五六年矣。今闻此处招军破贼，特来应募。"...`,
          wordCount: 3000,
          isFree: true
        },
        {
          chapterNumber: 2,
          title: '张翼德怒鞭督邮',
          content: `第二回 张翼德怒鞭督邮 何国舅谋诛宦竖

且说关、张、刘三人择日祭告天地，焚香再拜，结为兄弟。按年齿，玄德为兄，关羽为次，张飞为弟。祭罢，又杀牛设酒，聚乡中勇士，得三百余人。来日请出公子，寻找大队人马。

不一日，幽州太守刘焉发榜招军。玄德揭榜而往，入见太守，备言欲讨贼安民之意。刘焉大喜，遂令备招募义兵。于是刘备用度太史慈、关羽、张飞三将，选练得精兵五百，往青州依附太守，共讨黄巾。

此时黄巾贼众甚盛。张角为"太平道"，自称"黄天"，其弟张宝自称"地公将军"，张梁自称"人公将军"。因为汉室衰微，人心思乱，故此贼势甚大。角等所过州郡，官兵望风而靡，各处报告将军军士慌张失措。

诏书遣中郎将卢植、皇甫嵩、朱儁三路征剿。玄德引关、张直至卢植军中。卢植见玄德器宇轩昂，甚相敬重，遂表奏朝廷，令刘备为别部司马，随军剿贼...`,
          wordCount: 2800,
          isFree: true
        }
      ]
    },
    {
      title: '射雕英雄传',
      author: '金庸',
      categoryId: categories.find(c => c.name === '武侠')?.id,
      description: '《射雕英雄传》是金庸创作的长篇武侠小说，最初连载于1957—1959年的《香港商报》，后收录在《金庸作品集》中，是金庸"射雕三部曲"的第一部。该小说以宋、金、蒙古三国鼎立为背景，围绕郭靖、黄蓉的爱情故事和江湖恩怨展开，讲述了郭靖在江南七怪、全真派、黄药师等人的教导下成长为一代大侠的过程。',
      totalWords: 950000,
      totalChapters: 40,
      status: 'COMPLETED' as const,
      isFree: true,
      rating: 4.9,
      isFeatured: true,
      tags: ['武侠', '爱情', '江湖', '成长', '侠义'],
      chapters: [
        {
          chapterNumber: 1,
          title: '风雪惊变',
          content: `第一回 风雪惊变

钱塘江浩浩江水，日日夜夜无停无歇的从临安牛家村边绕过。江水是青的，两岸山色如黛。这是南宋宁宗庆元五年的暮春时分。

一个十八九岁的少年怯生生的在牛家村村口张望，这少年眉清目秀，只是脸色苍白，身上穿着一件破烂的灰布长衫。他叫杨康，是个从大漠来的少年。

村中有个牛家酒店，店前挂着一个破旧的酒幌子。店里有几张旧桌子，坐着几个村民在喝酒吃饭。忽听得店门外马蹄得得，从临安府城来了一队官兵。

为首一个中年汉子，身材高大，腰悬长剑，正是朝廷的包郎中。后面跟着七八个军士，都是甲胄鲜明。

包郎中进店来，向店主喝道："有个逃犯躲在你们村中，还不快快献出！"

店主战战兢兢道："小的不知有甚逃犯。"

包郎中怒道："有两个罪犯，一个姓郭名啸天，一个姓杨名铁心。这两人勾结金寇，通敌叛国，朝廷正在缉拿。"

听得这话，杨康脸色更白，身子微微发抖。

原来那杨铁心正是杨康的父亲，而郭啸天则是他父亲的结义兄弟...`,
          wordCount: 3500,
          isFree: true
        },
        {
          chapterNumber: 2,
          title: '江南七怪',
          content: `第二回 江南七怪

话说包郎中带着军士在牛家村搜查郭啸天、杨铁心不果，正要离去，忽听得远处传来一阵胡笳之声，甚是悠扬动听。

包郎中勒马停听，只见从江边芦苇荡中走出七个人来。为首一人年约五十，白须飘飘，手持一根竹杖，正是江南七怪之首柯镇恶，人称"飞天蝙蝠"。

第二个是个瘦长汉子，背负一张大弓，此乃朱聪，绰号"妙手书生"。第三个是个矮胖道人，姓韩名宝驹，人称"马王神"。第四个是个美貌女子，正是"越女剑"韩小莹。

其余三人：全金发，绰号"笑弥陀"；南希仁，绰号"南山樵子"；张阿生，绰号"卧龙先生"。这七人便是江南武林中赫赫有名的江南七怪。

柯镇恶上前拱手道："包大人，听闻你们在此搜查要犯，不知何人如此大胆，竟敢犯上作乱？"

包郎中见是江南七怪，不敢怠慢，拱手道："原来是柯大侠，失敬失敬。在下奉命捉拿逆贼郭啸天、杨铁心，此二人通敌叛国，罪大恶极。"

韩小莹听得，娇声道："包大人所言何人？在下倒要听听这两位豪杰犯了甚罪名？"

包郎中道："这郭啸天、杨铁心与金邦完颜洪烈勾结，里通外国，谋害忠良...`,
          wordCount: 3200,
          isFree: true
        }
      ]
    },
    {
      title: '斗破苍穹',
      author: '天蚕土豆',
      categoryId: categories.find(c => c.name === '玄幻')?.id,
      description: '三十年河东，三十年河西，莫欺少年穷！这是一个属于斗气的世界，没有花俏的魔法，有的，仅仅是繁衍到巅峰的斗气！等级森严的制度，新奇的炼药术，这里，强者为尊，等级森严！',
      totalWords: 5230000,
      totalChapters: 1648,
      status: 'COMPLETED' as const,
      isFree: false,
      rating: 4.6,
      isFeatured: true,
      tags: ['玄幻', '升级', '热血', '炼药', '异火'],
      chapters: [
        {
          chapterNumber: 1,
          title: '陨落的天才',
          content: `第一章 陨落的天才

"斗之力，三段！"

望着测验魔石碑上面闪亮得甚至有些刺眼的五个大字，少年面无表情，唇角有着一抹自嘲，紧握的手掌，因为大力，而导致略微尖锐的指甲深深的刺进了掌心之中，带来一阵阵钻心的疼痛…

"萧炎，斗之力，三段！级别：低级！"测验魔石碑之旁，一位中年男子，看了一眼碑上所显示出来的信息，语气漠然的将之公布了出来。

中年男子话刚刚脱口，便是在人群之中引起了一阵嘲讽的骚动。

"三段？嘿嘿，果然不出我所料！"

"我还以为这个曾经的天才，能给我们带来什么惊喜呢，原来，还是那副废物样子…"

"唉，真是一代不如一代啊，想当年萧炎可还曾是我们乌坦城年轻一辈中名头最响的天才呢，如今却…"

"谁叫人家以前风头出得太尽呢？风头出尽，遭雷劈，这不是应验了么？"

听着周围传来的各种嘲讽与挖苦，少年缓缓抬起头来，露出一张有些清秀的年轻脸庞，漆黑的眸子木然的在人群中扫过，少年嘴角的自嘲，似乎变得更加苦涩了。

"这些人，都曾经在自己面前卑躬屈膝的，现在…却是这般姿态。"萧炎心中苦笑，十四岁之前，他是家族中的第一天才，人人羡慕称赞的对象，然而自从十四岁之后，他的斗之力便是犹如老龟般，以令人作呕的速度缓慢前进着…`,
          wordCount: 4000,
          isFree: true
        },
        {
          chapterNumber: 2,
          title: '退婚',
          content: `第二章 退婚

萧炎缓缓走下高台，对于周围投射而来的各种目光，他也只是淡淡一笑，不过在这淡然的笑容下，却是隐藏着一抹连他自己都不曾察觉的阴霾与狠辣。

"耐心一点，总有一天，我会让你们知道，什么叫做三十年河东，三十年河西！"

在心中恶狠狠的念叨了一句，萧炎便是缓缓退到了人群的最后方，安静的等待着测验结束。

对于萧炎的退后，周围的人群很配合的让开了一条道路，不过从他们脸上，能够轻易的发现那如看废物一般的神色。

忍着心头的怒气，萧炎面无表情的在原地站立着，等待着测验的结束。

时间缓缓过去，测验台之上，时不时的便会爆发出一阵惊叹之声，不过这些，都与萧炎无关…

"萧薰儿，斗之力，七段！级别：高级！"

忽然间，测验台之上响起的清脆念叫声，让得萧炎微微一愣，旋即循声望去，只见那里，正有着一位身着紫色衣裙的少女亭亭而立。

少女看上去约莫十四五岁年纪，青丝随意的从香肩上垂下，一直延伸到那盈盈一握的小蛮腰处，精致的俏脸，不染丝毫杂质，淡雅若水的清眸，秀挺的琼鼻，粉嫩的小嘴，无一不在昭示着少女那绝美的容颜…

少女恬静的站在测验台之上，一袭紫色衣裙，将她那刚刚发育的娇躯勾勒得淡雅动人，看上去犹如一株幽谷中的兰花一般，清雅绝俗。`,
          wordCount: 3800,
          isFree: true
        }
      ]
    }
  ];

  // 创建书籍和章节
  for (const bookData of realBooks) {
    const { chapters, ...bookInfo } = bookData;
    
    const book = await prisma.book.create({
      data: bookInfo
    });
    
    console.log(`✅ 创建书籍: ${book.title}`);

    // 创建章节
    for (const chapterData of chapters) {
      await prisma.chapter.create({
        data: {
          bookId: book.id,
          ...chapterData
        }
      });
    }
    
    // 为每本书添加更多章节（使用生成的内容）
    const additionalChapters = Math.min(10, bookInfo.totalChapters - chapters.length);
    for (let i = chapters.length + 1; i <= chapters.length + additionalChapters; i++) {
      await prisma.chapter.create({
        data: {
          bookId: book.id,
          chapterNumber: i,
          title: `第${i}章 ${['新的开始', '意外发现', '重大转折', '激烈战斗', '神秘人物', '意外收获', '危机降临', '绝地反击', '胜利曙光', '新的征程'][i % 10]}`,
          content: `这是《${book.title}》第${i}章的内容。\n\n故事在这里继续展开，剧情愈发精彩。主角面临着新的挑战和机遇，每一个选择都可能改变整个故事的走向。\n\n在这个充满未知的世界里，友情、爱情、亲情交织在一起，构成了一幅波澜壮阔的画卷。让我们跟随主角的脚步，一起探索这个精彩的世界。\n\n（这是示例内容，实际开发中可以添加更丰富的真实内容）\n\n正文内容...\n\n更多精彩内容请继续阅读下一章。`,
          wordCount: 2000 + (i * 50),
          isFree: i <= 3 || book.isFree
        }
      });
    }
  }

  console.log('✅ 真实书籍内容创建成功');

  // 创建测试用户
  const bcrypt = require('bcryptjs');
  const hashedPassword = await bcrypt.hash('123456', 12);
  
  const testUser = await prisma.user.upsert({
    where: { username: 'testuser' },
    update: {},
    create: {
      username: 'testuser',
      email: 'test@example.com',
      password: hashedPassword
    }
  });

  console.log('✅ 测试用户创建成功 (用户名: testuser, 密码: 123456)');
  console.log('🎉 真实书籍内容种子数据插入完成！');
}

main()
  .catch((e) => {
    console.error('❌ 种子数据插入失败:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });